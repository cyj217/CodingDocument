from pymoo.core.problem import Problem
from pymoo.algorithms.moo.nsga2 import NSGA2
from pymoo.optimize import minimize
from pymoo.visualization.scatter import Scatter
from pymoo.core.variable import Real, Integer
import numpy as np

# 定义多目标优化问题
class MyProblem(Problem):
    def __init__(self):
        super().__init__(n_var=9, 
                         n_obj=3, 
                         n_constr=1, 
                         xl=np.array([20, 5, 4, 400, 20, 5, 3, 400, 20]),
                         xu=np.array([35, 12, 6, 800, 35, 9, 6, 800, 40]),
                         variable_type=[Real(), Real(), Integer(), Real(), Real(), Real(), Integer(), Real(), Real()]
                         )

    def _evaluate(self, x, out, *args, **kwargs):
        f1 = 0.06 * x[:, 2] * x[:, 3] * x[:, 8] + 0.06 * x[:, 6] * x[:, 7] * x[:, 8]
        f2 = x[:, 8]
        f3 = x[:, 0] * 0.21299 - x[:, 1] * 0.21868 - ((160 - x[:, 0] * 2) / (x[:, 2] - 1)) * 0.00861 + x[:, 3] * 0.00075 + x[:, 4] * 0.12388 + x[:, 5] * 0.04369 - ((160 - x[:, 4] * 2) / (x[:, 6] - 1)) * 0.03714 + x[:, 7] * 0.038619 + x[:, 8] * 0.013052 - 16.21145
        g = 935.98964725901897 - 0.013538728942482557 * x[:, 0] + 0.8021555651285219 * x[:, 1] - 2.31461158859571 * ((160 - x[:, 0] * 2) / (x[:, 2] - 1)) - 0.34888123618349576 * x[:, 3] - 1.0015743742718906 * x[:, 4] + 6.408123135775262 * x[:, 5] - 0.06402379927919208 * ((160 - x[:, 4] * 2) / (x[:, 6] - 1)) - 0.9954197090048814 * x[:, 7] - 14.684247994335902 * x[:, 8] - 6.14119116968629e-06 * x[:, 0] * x[:, 0] - 0.06028840477505551 * x[:, 0] * x[:, 1] + 0.022303630657638403 * x[:, 0] * ((160 - x[:, 0] * 2) / (x[:, 2] - 1)) - 0.0003393066276112123 * x[:, 0] * x[:, 3] + 0.0022882866326153183 * x[:, 0] * x[:, 4] - 0.04625452089589313 * x[:, 0] * x[:, 5] - 0.002796553845474784 * x[:, 0] * ((160 - x[:, 4] * 2) / (x[:, 6] - 1)) + 0.00016909271264526488 * x[:, 0] * x[:, 7] + 0.00831677960311284 * x[:, 0] * x[:, 8] + 0.016068245547147045 * x[:, 1] * x[:, 1] + 0.05003471433709873 * x[:, 1] * ((160 - x[:, 0] * 2) / (x[:, 2] - 1)) + 0.002184539754952433 * x[:, 1] * x[:, 3] + 0.014698844066333226 * x[:, 1] * x[:, 4] - 0.007624084884847518 * x[:, 1] * x[:, 5] - 0.004184058645558333 * x[:, 1] * ((160 - x[:, 4] * 2) / (x[:, 6] - 1)) - 0.000835409143362463 * x[:, 1] * x[:, 7] + 0.0038455779784788285 * x[:, 1] * x[:, 8] + 0.016656065982318585 * ((160 - x[:, 0] * 2) / (x[:, 2] - 1)) * ((160 - x[:, 0] * 2) / (x[:, 2] - 1)) + 0.0002216719875300019 * ((160 - x[:, 0] * 2) / (x[:, 2] - 1)) * x[:, 3] + 0.008197009208413 * ((160 - x[:, 0] * 2) / (x[:, 2] - 1)) * x[:, 4] - 0.03432430468901351 * ((160 - x[:, 0] * 2) / (x[:, 2] - 1)) * x[:, 5] + 0.0002876386630689537 * ((160 - x[:, 0] * 2) / (x[:, 2] - 1)) * ((160 - x[:, 4] * 2) / (x[:, 6] - 1)) + 0.00021394225410412138 * ((160 - x[:, 0] * 2) / (x[:, 2] - 1)) * x[:, 7] + 0.00754136878212136 * ((160 - x[:, 0] * 2) / (x[:, 2] - 1)) * x[:, 8] + 3.113356291239988e-05 * x[:, 3] * x[:, 3] + 0.0002315153602820974 * x[:, 3] * x[:, 4] + 0.0009182323416609961 * x[:, 3] * x[:, 5] - 4.971923156071867e-05 * x[:, 3] * ((160 - x[:, 4] * 2) / (x[:, 6] - 1)) + 0.00017493479445593318 * x[:, 3] * x[:, 7] + 0.0012432978872798373 * x[:, 3] * x[:, 8] + 0.011170071577092155 * x[:, 4] * x[:, 4] - 0.006654576036150939 * x[:, 4] * x[:, 5] + 0.0007189835646677079 * x[:, 4] * ((160 - x[:, 4] * 2) / (x[:, 6] - 1)) - 0.0005942461732251214 * x[:, 4] * x[:, 7] + 0.0020100234579322127 * x[:, 4] * x[:, 8] - 0.3036892859102304 * x[:, 5] * x[:, 5] - 0.0006436414464011664 * x[:, 5] * ((160 - x[:, 4] * 2) / (x[:, 6] - 1)) - 0.00018696298242648623 * x[:, 5] * x[:, 7] - 0.0034499337053868206 * x[:, 5] * x[:, 8] + 0.0016061913109384207 * ((160 - x[:, 4] * 2) / (x[:, 6] - 1)) * ((160 - x[:, 4] * 2) / (x[:, 6] - 1)) - 3.940402188651326e-05 * ((160 - x[:, 4] * 2) / (x[:, 6] - 1)) * x[:, 7] - 0.00034841068526869634 * ((160 - x[:, 4] * 2) / (x[:, 6] - 1)) * x[:, 8] + 0.0002680047611804959 * x[:, 7] * x[:, 7] + 0.003988708085397974 * x[:, 7] * x[:, 8] + 0.15166235631019154 * x[:, 8] * x[:, 8]
        out["F"] = np.column_stack([f1, f2, f3])
        out["G"] = g


# 创建多目标优化问题实例
problem = MyProblem()

# 创建NSGA-II算法实例
algorithm = NSGA2(pop_size=100, crossover_prob=0.9)

# 执行多目标优化
res = minimize(problem,
               algorithm,
               ('n_gen', 100),
               seed=1,
               verbose=False)

# 输出优化结果
print("最优解：")
print(res.X)
print("最优目标函数值：")
print(res.F)

# 可视化结果
plot = Scatter()
plot.add(res.F, color="red")
plot.show()
